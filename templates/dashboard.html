<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SGMRP</title>
    <meta name="description" content="Painel principal do Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Notifica√ß√£o de sucesso */
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }

        .notification-content {
            background: #16a34a;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            max-width: 400px;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            opacity: 0.8;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .success-notification.closing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        /* Responsividade */
        @media (max-width: 480px) {
            .success-notification {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            
            .notification-content {
                min-width: auto;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}" class="active">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="#relatorios">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Notifica√ß√£o de Login Bem-sucedido -->
    {% if mostrar_login_sucesso %}
    <div id="loginSuccessNotification" class="success-notification">
        <div class="notification-content">
            <div class="notification-icon">‚úÖ</div>
            <div class="notification-text">
                <strong>Login realizado com sucesso!</strong>
                <br>Bem-vindo(a), {{ usuario_nome or 'Usu√°rio' }}!
            </div>
            <button type="button" class="notification-close" onclick="closeNotification()">√ó</button>
        </div>
    </div>
    {% endif %}

    <main>
        <div class="container">
            <!-- Boas-vindas e informa√ß√µes do usu√°rio -->
            <section style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; border-radius: var(--border-radius-xl); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h1 style="color: white; margin-bottom: 0.5rem;">
                            Bem-vindo ao SGMRP
                        </h1>
                        <p style="margin-bottom: 0; opacity: 0.9;">
                            <span id="usuario-nome">Usu√°rio</span> - <span id="usuario-cargo">Funcion√°rio da SFA</span>
                        </p>
                        <p style="margin-bottom: 0; font-size: 0.875rem; opacity: 0.8;">
                            √öltimo acesso: <span id="ultimo-acesso">19/10/2025 - 14:30</span>
                        </p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">
                            Sistema Operacional
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filtros Globais -->
            <section class="filters fade-in">
                <h3 style="margin-bottom: 1rem;">Filtros Globais</h3>
                <div class="filters-row">
                    <div style="flex: 1;">
                        <label for="filtro-mes" class="form-label">M√™s</label>
                        <select id="filtro-mes" class="form-select">
                            <option value="">Todos os meses</option>
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Mar√ßo</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label for="filtro-ano" class="form-label">Ano</label>
                        <select id="filtro-ano" class="form-select">
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label for="filtro-lote" class="form-label">Lote</label>
                        <select id="filtro-lote" class="form-select">
                            <option value="">Todos os lotes</option>
                            {% for lote in lotes %}
                            <option value="{{ lote.id }}">{{ lote.nome }} - {{ lote.empresa }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </section>

            <!-- Resumo Estat√≠stico -->
            <section style="margin-bottom: 3rem;">
                <h2>Resumo do Per√≠odo</h2>
                <div class="grid grid-cols-4">
                    <div class="card fade-in">
                        <div class="card-body" style="text-align: center; padding: 2rem 1rem;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üè¢</div>
                            <h3 style="color: var(--primary-color); margin-bottom: 0.25rem;" id="resumo-unidades">15</h3>
                            <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Unidades Ativas</p>
                        </div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-body" style="text-align: center; padding: 2rem 1rem;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üçΩÔ∏è</div>
                            <h3 style="color: var(--success-color); margin-bottom: 0.25rem;" id="resumo-refeicoes">124,350</h3>
                            <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Refei√ß√µes Servidas</p>
                        </div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-body" style="text-align: center; padding: 2rem 1rem;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                            <h3 style="color: var(--warning-color); margin-bottom: 0.25rem;" id="resumo-discrepancias">8</h3>
                            <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Discrep√¢ncias</p>
                        </div>
                    </div>
                    <div class="card fade-in">
                        <div class="card-body" style="text-align: center; padding: 2rem 1rem;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
                            <h3 style="color: var(--success-color); margin-bottom: 0.25rem;" id="resumo-conformidade">94.2%</h3>
                            <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">Conformidade</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Lotes Contratuais -->
            <section>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Lotes Contratuais</h2>
                    <a href="{{ url_for('lotes') }}" class="btn btn-secondary">
                        Ver Todos os Lotes
                    </a>
                </div>

                <div class="lote-grid">
                    {% for lote in lotes %}
                    <!-- Lote {{ lote.id }} -->
                    <a href="{{ url_for('lote_detalhes', lote_id=lote.id) }}" class="lote-card fade-in" data-lote-id="{{ lote.id }}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h3 style="margin-bottom: 0.25rem;">{{ lote.nome }}</h3>
                                <div style="font-size: 0.75rem; opacity: 0.8;">
                                    <strong>{{ lote.contrato }}</strong> - {{ lote.data_inicio_contrato }}
                                </div>
                            </div>
                            <div class="badge" style="background-color: rgba(255, 255, 255, 0.2); color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                                {% if lote.ativo %}ATIVO{% else %}INATIVO{% endif %}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <p class="presidios-count" style="margin: 0;">
                                <strong><span class="unidades-count" data-lote-id="{{ lote.id }}">{{ lote.unidades | length }}</span> unidades</strong> ‚Ä¢ {{ lote.empresa }}
                            </p>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem;">üçΩÔ∏è</div>
                                <div style="font-size: 0.875rem; opacity: 0.9;" class="refeicoes-count" data-lote-id="{{ lote.id }}">{{ "{:,}".format(lote.refeicoes | default(15000 + (lote.id * 2000), true)).replace(',', '.') }}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Refei√ß√µes</div>
                            </div>
                            <div style="text-align: center;">
                                {% set conformidade = lote.conformidade | default(85 + (lote.id % 3 * 5), true) %}
                                <div style="font-size: 1.5rem;" class="conformidade-icon" data-lote-id="{{ lote.id }}">
                                    {% if conformidade >= 95 %}‚úÖ{% elif conformidade >= 90 %}‚ö†Ô∏è{% else %}üö®{% endif %}
                                </div>
                                <div style="font-size: 0.875rem; opacity: 0.9;" class="conformidade-percent" data-lote-id="{{ lote.id }}">{{ conformidade }}%</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Conformidade</div>
                            </div>
                            <div style="text-align: center;">
                                {% set alertas = lote.alertas | default(lote.id % 4, true) %}
                                <div style="font-size: 1.5rem;" class="alertas-icon" data-lote-id="{{ lote.id }}">
                                    {% if alertas == 0 %}‚úÖ{% else %}‚ö†Ô∏è{% endif %}
                                </div>
                                <div style="font-size: 0.875rem; opacity: 0.9;" class="discrepancias-count" data-lote-id="{{ lote.id }}">{{ alertas }}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">Discrep√¢ncias</div>
                            </div>
                        </div>

                        <div style="font-size: 0.75rem; opacity: 0.8;">
                            √öltima atualiza√ß√£o: 19/10/2025
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </section>

            <!-- Alertas Recentes -->
            <section style="margin-top: 3rem;">
                <h2>Alertas e Discrep√¢ncias Recentes</h2>
                <div class="card fade-in">
                    <div class="card-body">
                        <div style="display: grid; gap: 1rem;">
                            <div class="alert alert-warning" style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                                <div style="flex: 1;">
                                    <strong>Pres√≠dio Central - Lote 2</strong><br>
                                    <span style="font-size: 0.875rem;">Diferen√ßa de +12 refei√ß√µes no almo√ßo do dia 18/10/2025</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">
                                    H√° 1 dia
                                </div>
                            </div>

                            <div class="alert alert-danger" style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 1.5rem;">üö®</div>
                                <div style="flex: 1;">
                                    <strong>Penitenci√°ria Norte - Lote 4</strong><br>
                                    <span style="font-size: 0.875rem;">Diferen√ßa de +25 refei√ß√µes no jantar do dia 17/10/2025</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">
                                    H√° 2 dias
                                </div>
                            </div>

                            <div class="alert alert-info" style="display: flex; align-items: center; gap: 1rem;">
                                <div style="font-size: 1.5rem;">‚ÑπÔ∏è</div>
                                <div style="flex: 1;">
                                    <strong>Casa de Cust√≥dia Sul - Lote 1</strong><br>
                                    <span style="font-size: 0.875rem;">Dados do SIISP atualizados - diferen√ßas resolvidas</span>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--gray-500);">
                                    H√° 3 dias
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 1.5rem;">
                            <a href="#relatorios" class="btn btn-secondary">
                                Ver Todos os Alertas
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- A√ß√µes R√°pidas -->
            <section style="margin-top: 3rem; margin-bottom: 2rem;">
                <h2>A√ß√µes R√°pidas</h2>
                <div class="grid grid-cols-3">
                    <div class="card fade-in" style="cursor: pointer;" onclick="window.location.href='lote-detalhes.html?lote=1&acao=importar'">
                        <div class="card-body" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
                            <h4>Importar Dados</h4>
                            <p style="color: var(--gray-600); margin: 0;">
                                Importar novos mapas de refei√ß√£o via PDF
                            </p>
                        </div>
                    </div>

                    <div class="card fade-in" style="cursor: pointer;" onclick="window.location.href='lote-detalhes.html?acao=manual'">
                        <div class="card-body" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úèÔ∏è</div>
                            <h4>Entrada Manual</h4>
                            <p style="color: var(--gray-600); margin: 0;">
                                Registrar dados manualmente
                            </p>
                        </div>
                    </div>

                    <div class="card fade-in" style="cursor: pointer;" onclick="alert('Funcionalidade de relat√≥rios ser√° implementada em vers√µes futuras.')">
                        <div class="card-body" style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                            <h4>Gerar Relat√≥rio</h4>
                            <p style="color: var(--gray-600); margin: 0;">
                                Criar relat√≥rio consolidado
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Dados dos mapas e lotes vindos do Flask
        const mapasDados = {{ mapas_dados | tojson }};
        const lotesGlobal = {{ lotes | tojson }};
        
        // Verificar se usu√°rio est√° logado (simula√ß√£o)
        window.addEventListener('load', function() {
            // Em uma aplica√ß√£o real, isso verificaria o token de autentica√ß√£o
            const usuarioSalvo = localStorage.getItem('sgmrp_usuario');
            if (!usuarioSalvo) {
                alert('Sess√£o expirada. Redirecionando para login.');
                window.location.href = 'login.html';
                return;
            }

            // Atualizar informa√ß√µes do usu√°rio na interface
            document.getElementById('usuario-nome').textContent = usuarioSalvo || 'Usu√°rio';
            
            // Definir m√™s anterior como padr√£o no filtro
            setDefaultPreviousMonth();
            
            // Calcular resumo inicial baseado no filtro padr√£o
            atualizarResumo();
        });

        // Fun√ß√£o para definir o m√™s anterior como padr√£o
        function setDefaultPreviousMonth() {
            const now = new Date();
            let previousMonth = now.getMonth(); // getMonth() retorna 0-11 (Janeiro=0)
            let previousYear = now.getFullYear();
            
            // Se estamos em Janeiro, o m√™s anterior √© Dezembro do ano passado
            if (previousMonth === 0) {
                previousMonth = 12;
                previousYear--;
            }
            
            // Selecionar o m√™s anterior no filtro
            const filtroMes = document.getElementById('filtro-mes');
            const filtroAno = document.getElementById('filtro-ano');
            
            if (filtroMes && filtroAno) {
                filtroMes.value = previousMonth.toString();
                filtroAno.value = previousYear.toString();
            }
        }

        // Fun√ß√£o para calcular e atualizar o resumo baseado nos filtros
        function atualizarResumo() {
            const mes = parseInt(document.getElementById('filtro-mes').value);
            const ano = parseInt(document.getElementById('filtro-ano').value);
            const loteId = parseInt(document.getElementById('filtro-lote').value);
            
            console.log('Atualizando resumo para:', { mes, ano, loteId });
            
            // Filtrar mapas baseado nos crit√©rios
            let mapasFiltrados = mapasDados;
            
            if (mes) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.mes === mes);
            }
            
            if (ano) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.ano === ano);
            }
            
            if (loteId) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.lote_id === loteId);
            }
            
            console.log('Mapas filtrados:', mapasFiltrados.length);
            
            // Calcular estat√≠sticas
            const estatisticas = calcularEstatisticas(mapasFiltrados);
            
            // Atualizar interface do resumo
            document.getElementById('resumo-unidades').textContent = estatisticas.unidades.toString();
            document.getElementById('resumo-refeicoes').textContent = estatisticas.refeicoes.toLocaleString('pt-BR');
            document.getElementById('resumo-discrepancias').textContent = estatisticas.discrepancias.toString();
            document.getElementById('resumo-conformidade').textContent = estatisticas.conformidade + '%';
            
            // Atualizar cards dos lotes
            atualizarCardsLotes();
            
            console.log('Resumo atualizado:', estatisticas);
        }
        
        // Fun√ß√£o para calcular estat√≠sticas dos mapas filtrados
        function calcularEstatisticas(mapas) {
            // Calcular n√∫mero total de unidades dos lotes ativos (independente dos mapas)
            const loteIdSelecionado = parseInt(document.getElementById('filtro-lote').value);
            let totalUnidadesLotes = 0;
            
            if (loteIdSelecionado) {
                // Se um lote espec√≠fico est√° selecionado, mostrar apenas suas unidades
                const loteEspecifico = lotesGlobal.find(l => l.id === loteIdSelecionado);
                totalUnidadesLotes = loteEspecifico ? loteEspecifico.unidades.length : 0;
            } else {
                // Se nenhum lote espec√≠fico, mostrar total de todas as unidades de todos os lotes
                totalUnidadesLotes = lotesGlobal.reduce((total, lote) => total + lote.unidades.length, 0);
            }
            
            if (!mapas || mapas.length === 0) {
                return {
                    unidades: totalUnidadesLotes,
                    refeicoes: 0,
                    discrepancias: 0,
                    conformidade: '0.0'
                };
            }
            
            const unidadesUnicas = new Set();
            let totalRefeicoes = 0;
            let totalRegistros = 0;
            let registrosComDiscrepancia = 0;
            
            // Usar pre√ßos reais do lote se poss√≠vel
            let precos = null;
            if (mapas && mapas.length > 0) {
                // Tenta pegar o lote do primeiro mapa
                const loteId = mapas[0].lote_id;
                const loteObj = lotesGlobal.find(l => l.id === loteId);
                if (loteObj && loteObj.precos) {
                    precos = loteObj.precos;
                }
            }
            // Fallback para pre√ßos simulados se n√£o houver pre√ßos reais
            if (!precos) {
                precos = {
                    cafe: { interno: 4.50, funcionario: 5.00 },
                    almoco: { interno: 12.00, funcionario: 13.50 },
                    lanche: { interno: 6.00, funcionario: 6.50 },
                    jantar: { interno: 10.00, funcionario: 11.00 }
                };
            }
            
            let valorTotal = 0;
            let valorDesvio = 0;
            
            mapas.forEach(mapa => {
                unidadesUnicas.add(mapa.nome_unidade);
                
                // Calcular total de refei√ß√µes e valores financeiros para cada dia do m√™s
                for (let i = 0; i < mapa.data.length; i++) {
                    const refeicoesDia = 
                        mapa.cafe_interno[i] + mapa.cafe_funcionario[i] +
                        mapa.almoco_interno[i] + mapa.almoco_funcionario[i] +
                        mapa.lanche_interno[i] + mapa.lanche_funcionario[i] +
                        mapa.jantar_interno[i] + mapa.jantar_funcionario[i];
                    
                    totalRefeicoes += refeicoesDia;
                    totalRegistros++;
                    
                    // Calcular valores financeiros
                    const valorDia = 
                        (mapa.cafe_interno[i] * precos.cafe.interno) +
                        (mapa.cafe_funcionario[i] * precos.cafe.funcionario) +
                        (mapa.almoco_interno[i] * precos.almoco.interno) +
                        (mapa.almoco_funcionario[i] * precos.almoco.funcionario) +
                        (mapa.lanche_interno[i] * precos.lanche.interno) +
                        (mapa.lanche_funcionario[i] * precos.lanche.funcionario) +
                        (mapa.jantar_interno[i] * precos.jantar.interno) +
                        (mapa.jantar_funcionario[i] * precos.jantar.funcionario);
                    
                    valorTotal += valorDia;
                    
                    // Calcular desvios financeiros usando colunas _siisp quando dispon√≠veis
                    const siisp = (mapa.n_siisp && mapa.n_siisp.length > i) ? mapa.n_siisp[i] : 0;
                    
                    // Usar colunas _siisp se dispon√≠veis (j√° calculadas), sen√£o calcular na hora
                    const usarColunasSiisp = mapa.cafe_interno_siisp && mapa.cafe_interno_siisp.length > i;
                    
                    if (usarColunasSiisp) {
                        // Usar valores j√° calculados das colunas _siisp para detectar discrep√¢ncias
                        // INCLUIR TODOS OS EXCEDENTES no desvio (mesmo os pequenos)
                        const excedenteCafe = mapa.cafe_interno_siisp[i] > 0 ? mapa.cafe_interno_siisp[i] : 0;
                        const excedenteAlmoco = mapa.almoco_interno_siisp[i] > 0 ? mapa.almoco_interno_siisp[i] : 0;
                        const excedenteLanche = mapa.lanche_interno_siisp[i] > 0 ? mapa.lanche_interno_siisp[i] : 0;
                        const excedenteJantar = mapa.jantar_interno_siisp[i] > 0 ? mapa.jantar_interno_siisp[i] : 0;
                        
                        valorDesvio += 
                            (excedenteCafe * precos.cafe.interno) +
                            (excedenteAlmoco * precos.almoco.interno) +
                            (excedenteLanche * precos.lanche.interno) +
                            (excedenteJantar * precos.jantar.interno);
                        
                        // Contar discrep√¢ncias cr√≠ticas usando colunas _siisp (apenas > 5)
                        if (mapa.cafe_interno_siisp[i] > 5) registrosComDiscrepancia++;
                        if (mapa.almoco_interno_siisp[i] > 5) registrosComDiscrepancia++;
                        if (mapa.lanche_interno_siisp[i] > 5) registrosComDiscrepancia++;
                        if (mapa.jantar_interno_siisp[i] > 5) registrosComDiscrepancia++;
                        
                        // Verificar funcion√°rios SIISP usando colunas calculadas
                        if (mapa.cafe_funcionario_siisp && mapa.cafe_funcionario_siisp[i] > 0) {
                            registrosComDiscrepancia++;
                            valorDesvio += mapa.cafe_funcionario_siisp[i] * precos.cafe.funcionario;
                        }
                        if (mapa.almoco_funcionario_siisp && mapa.almoco_funcionario_siisp[i] > 0) {
                            registrosComDiscrepancia++;
                            valorDesvio += mapa.almoco_funcionario_siisp[i] * precos.almoco.funcionario;
                        }
                        if (mapa.lanche_funcionario_siisp && mapa.lanche_funcionario_siisp[i] > 0) {
                            registrosComDiscrepancia++;
                            valorDesvio += mapa.lanche_funcionario_siisp[i] * precos.lanche.funcionario;
                        }
                        if (mapa.jantar_funcionario_siisp && mapa.jantar_funcionario_siisp[i] > 0) {
                            registrosComDiscrepancia++;
                            valorDesvio += mapa.jantar_funcionario_siisp[i] * precos.jantar.funcionario;
                        }
                    } else if (siisp > 0) {
                        // Fallback: calcular na hora se n√£o h√° colunas _siisp
                        const excedenteCafe = Math.max(0, mapa.cafe_interno[i] - siisp);
                        const excedenteAlmoco = Math.max(0, mapa.almoco_interno[i] - siisp);
                        const excedenteLanche = Math.max(0, mapa.lanche_interno[i] - siisp);
                        const excedenteJantar = Math.max(0, mapa.jantar_interno[i] - siisp);
                        
                        valorDesvio += 
                            (excedenteCafe * precos.cafe.interno) +
                            (excedenteAlmoco * precos.almoco.interno) +
                            (excedenteLanche * precos.lanche.interno) +
                            (excedenteJantar * precos.jantar.interno);
                        
                        // Contar discrep√¢ncias cr√≠ticas
                        if (excedenteCafe > 5) registrosComDiscrepancia++;
                        if (excedenteAlmoco > 5) registrosComDiscrepancia++;
                        if (excedenteLanche > 5) registrosComDiscrepancia++;
                        if (excedenteJantar > 5) registrosComDiscrepancia++;
                    }
                }
            });
            
            // Calcular conformidade baseada em impacto financeiro
            const conformidade = valorTotal > 0 ? 
                Math.max(0, ((valorTotal - valorDesvio) / valorTotal) * 100).toFixed(1) : 
                '0.0';
            
            return {
                unidades: totalUnidadesLotes, // Usar total de unidades dos lotes, n√£o das unidades √∫nicas nos mapas
                refeicoes: totalRefeicoes,
                discrepancias: registrosComDiscrepancia,
                conformidade: conformidade
            };
        }
        
        // Fun√ß√£o para calcular estat√≠sticas individuais de cada lote
        function calcularEstatisticasLote(loteId, mapasFiltrados) {
            // Obter n√∫mero total de unidades do lote (independente dos mapas)
            const lote = lotesGlobal.find(l => l.id === loteId);
            const totalUnidadesLote = lote ? lote.unidades.length : 0;
            
            // Filtrar mapas apenas para o lote espec√≠fico
            const mapasDoLote = mapasFiltrados.filter(mapa => mapa.lote_id === loteId);
            
            if (!mapasDoLote || mapasDoLote.length === 0) {
                return {
                    unidades: totalUnidadesLote, // Mostrar sempre o n√∫mero total de unidades do lote
                    refeicoes: 0,
                    conformidade: '0.0',
                    discrepancias: 0
                };
            }
            
            const unidadesUnicas = new Set();
            let totalRefeicoes = 0;
            let totalRegistros = 0;
            let registrosComProblema = 0;
            
            // Usar pre√ßos reais do lote se poss√≠vel
            let precos = null;
            const loteObj = lotesGlobal.find(l => l.id === loteId);
            if (loteObj && loteObj.precos) {
                precos = loteObj.precos;
            }
            // Fallback para pre√ßos simulados se n√£o houver pre√ßos reais
            if (!precos) {
                precos = {
                    cafe: { interno: 4.50, funcionario: 5.00 },
                    almoco: { interno: 12.00, funcionario: 13.50 },
                    lanche: { interno: 6.00, funcionario: 6.50 },
                    jantar: { interno: 10.00, funcionario: 11.00 }
                };
            }
            
            let valorTotal = 0;
            let valorDesvio = 0;
            
            mapasDoLote.forEach(mapa => {
                unidadesUnicas.add(mapa.nome_unidade);
                
                // Calcular total de refei√ß√µes e valores financeiros para cada dia do m√™s
                for (let i = 0; i < mapa.data.length; i++) {
                    const refeicoesDia = 
                        mapa.cafe_interno[i] + mapa.cafe_funcionario[i] +
                        mapa.almoco_interno[i] + mapa.almoco_funcionario[i] +
                        mapa.lanche_interno[i] + mapa.lanche_funcionario[i] +
                        mapa.jantar_interno[i] + mapa.jantar_funcionario[i];
                    
                    totalRefeicoes += refeicoesDia;
                    totalRegistros++;
                    
                    // Calcular valores financeiros
                    const valorDia = 
                        (mapa.cafe_interno[i] * precos.cafe.interno) +
                        (mapa.cafe_funcionario[i] * precos.cafe.funcionario) +
                        (mapa.almoco_interno[i] * precos.almoco.interno) +
                        (mapa.almoco_funcionario[i] * precos.almoco.funcionario) +
                        (mapa.lanche_interno[i] * precos.lanche.interno) +
                        (mapa.lanche_funcionario[i] * precos.lanche.funcionario) +
                        (mapa.jantar_interno[i] * precos.jantar.interno) +
                        (mapa.jantar_funcionario[i] * precos.jantar.funcionario);
                    
                    valorTotal += valorDia;
                    
                    // Calcular desvios financeiros usando colunas _siisp quando dispon√≠veis
                    const siisp = (mapa.n_siisp && mapa.n_siisp.length > i) ? mapa.n_siisp[i] : 0;
                    
                    // Usar colunas _siisp se dispon√≠veis (j√° calculadas), sen√£o calcular na hora
                    const usarColunasSiisp = mapa.cafe_interno_siisp && mapa.cafe_interno_siisp.length > i;
                    
                    if (usarColunasSiisp) {
                        // Usar valores j√° calculados das colunas _siisp para detectar discrep√¢ncias
                        // INCLUIR TODOS OS EXCEDENTES no desvio (mesmo os pequenos)
                        const excedenteCafe = mapa.cafe_interno_siisp[i] > 0 ? mapa.cafe_interno_siisp[i] : 0;
                        const excedenteAlmoco = mapa.almoco_interno_siisp[i] > 0 ? mapa.almoco_interno_siisp[i] : 0;
                        const excedenteLanche = mapa.lanche_interno_siisp[i] > 0 ? mapa.lanche_interno_siisp[i] : 0;
                        const excedenteJantar = mapa.jantar_interno_siisp[i] > 0 ? mapa.jantar_interno_siisp[i] : 0;
                        
                        valorDesvio += 
                            (excedenteCafe * precos.cafe.interno) +
                            (excedenteAlmoco * precos.almoco.interno) +
                            (excedenteLanche * precos.lanche.interno) +
                            (excedenteJantar * precos.jantar.interno);
                        
                        // Contar discrep√¢ncias cr√≠ticas usando colunas _siisp (apenas > 5)
                        if (mapa.cafe_interno_siisp[i] > 5) registrosComProblema++;
                        if (mapa.almoco_interno_siisp[i] > 5) registrosComProblema++;
                        if (mapa.lanche_interno_siisp[i] > 5) registrosComProblema++;
                        if (mapa.jantar_interno_siisp[i] > 5) registrosComProblema++;
                        
                        // Verificar funcion√°rios SIISP usando colunas calculadas
                        if (mapa.cafe_funcionario_siisp && mapa.cafe_funcionario_siisp[i] > 0) {
                            registrosComProblema++;
                            valorDesvio += mapa.cafe_funcionario_siisp[i] * precos.cafe.funcionario;
                        }
                        if (mapa.almoco_funcionario_siisp && mapa.almoco_funcionario_siisp[i] > 0) {
                            registrosComProblema++;
                            valorDesvio += mapa.almoco_funcionario_siisp[i] * precos.almoco.funcionario;
                        }
                        if (mapa.lanche_funcionario_siisp && mapa.lanche_funcionario_siisp[i] > 0) {
                            registrosComProblema++;
                            valorDesvio += mapa.lanche_funcionario_siisp[i] * precos.lanche.funcionario;
                        }
                        if (mapa.jantar_funcionario_siisp && mapa.jantar_funcionario_siisp[i] > 0) {
                            registrosComProblema++;
                            valorDesvio += mapa.jantar_funcionario_siisp[i] * precos.jantar.funcionario;
                        }
                    } else if (siisp > 0) {
                        // Fallback: calcular na hora se n√£o h√° colunas _siisp
                        const excedenteCafe = Math.max(0, mapa.cafe_interno[i] - siisp);
                        const excedenteAlmoco = Math.max(0, mapa.almoco_interno[i] - siisp);
                        const excedenteLanche = Math.max(0, mapa.lanche_interno[i] - siisp);
                        const excedenteJantar = Math.max(0, mapa.jantar_interno[i] - siisp);
                        
                        valorDesvio += 
                            (excedenteCafe * precos.cafe.interno) +
                            (excedenteAlmoco * precos.almoco.interno) +
                            (excedenteLanche * precos.lanche.interno) +
                            (excedenteJantar * precos.jantar.interno);
                        
                        // Contar discrep√¢ncias cr√≠ticas
                        if (excedenteCafe > 5) registrosComProblema++;
                        if (excedenteAlmoco > 5) registrosComProblema++;
                        if (excedenteLanche > 5) registrosComProblema++;
                        if (excedenteJantar > 5) registrosComProblema++;
                    }
                }
            });
            
            // Calcular conformidade baseada em impacto financeiro
            const conformidade = valorTotal > 0 ? 
                Math.max(0, ((valorTotal - valorDesvio) / valorTotal) * 100).toFixed(1) : 
                '0.0';
            
            // Retornar discrep√¢ncias cr√≠ticas calculadas
            const discrepancias = registrosComProblema;
            
            return {
                unidades: totalUnidadesLote, // Usar sempre o n√∫mero total de unidades do lote
                refeicoes: totalRefeicoes,
                conformidade: conformidade,
                discrepancias: discrepancias
            };
        }
        
        // Fun√ß√£o para atualizar cards dos lotes
        function atualizarCardsLotes() {
            const mes = parseInt(document.getElementById('filtro-mes').value);
            const ano = parseInt(document.getElementById('filtro-ano').value);
            const loteId = parseInt(document.getElementById('filtro-lote').value);
            
            // Filtrar mapas baseado nos crit√©rios
            let mapasFiltrados = mapasDados;
            
            if (mes) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.mes === mes);
            }
            
            if (ano) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.ano === ano);
            }
            
            if (loteId) {
                mapasFiltrados = mapasFiltrados.filter(mapa => mapa.lote_id === loteId);
            }
            
            // Atualizar cada card de lote
            document.querySelectorAll('.lote-card').forEach(card => {
                const loteId = parseInt(card.getAttribute('data-lote-id'));
                const estatisticas = calcularEstatisticasLote(loteId, mapasFiltrados);
                
                // Atualizar unidades
                const unidadesElement = card.querySelector('.unidades-count');
                if (unidadesElement) {
                    unidadesElement.textContent = estatisticas.unidades;
                }
                
                // Atualizar refei√ß√µes
                const refeicoesElement = card.querySelector('.refeicoes-count');
                if (refeicoesElement) {
                    refeicoesElement.textContent = estatisticas.refeicoes.toLocaleString('pt-BR');
                }
                
                // Atualizar conformidade
                const conformidadePercentElement = card.querySelector('.conformidade-percent');
                const conformidadeIconElement = card.querySelector('.conformidade-icon');
                if (conformidadePercentElement) {
                    // Garantir que sempre mostre com uma casa decimal (ex: 0.0%, 95.5%)
                    const conformidadeFormatada = typeof estatisticas.conformidade === 'string' ? 
                        estatisticas.conformidade : estatisticas.conformidade.toFixed(1);
                    conformidadePercentElement.textContent = conformidadeFormatada + '%';
                }
                if (conformidadeIconElement) {
                    const conformidadeNum = parseFloat(estatisticas.conformidade);
                    if (conformidadeNum >= 95) {
                        conformidadeIconElement.textContent = '‚úÖ';
                    } else if (conformidadeNum >= 90) {
                        conformidadeIconElement.textContent = '‚ö†Ô∏è';
                    } else {
                        conformidadeIconElement.textContent = 'üö®';
                    }
                }
                
                // Atualizar discrep√¢ncias
                const discrepanciasCountElement = card.querySelector('.discrepancias-count');
                const discrepanciasIconElement = card.querySelector('.alertas-icon'); // Mant√©m classe antiga para compatibilidade
                if (discrepanciasCountElement) {
                    discrepanciasCountElement.textContent = estatisticas.discrepancias;
                }
                if (discrepanciasIconElement) {
                    discrepanciasIconElement.textContent = estatisticas.discrepancias === 0 ? '‚úÖ' : '‚ö†Ô∏è';
                }
            });
            
            console.log('Cards dos lotes atualizados baseado nos filtros');
        }

        // Logout
        document.getElementById('logoutLink').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                localStorage.removeItem('sgmrp_usuario');
                localStorage.removeItem('sgmrp_remember');
                window.location.href = 'login.html';
            }
        });





        // Filtro de lote em tempo real
        document.getElementById('filtro-lote').addEventListener('change', function() {
            const loteId = parseInt(this.value);
            
            // Atualizar resumo quando filtro de lote mudar
            atualizarResumo();
            
            // Filtrar cards de lote visualmente
            const loteCards = document.querySelectorAll('.lote-card');
            loteCards.forEach(card => {
                const cardLoteId = parseInt(card.getAttribute('data-lote-id'));
                if (!loteId || cardLoteId === loteId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        // Event listeners para atualiza√ß√£o autom√°tica do resumo
        document.getElementById('filtro-mes').addEventListener('change', atualizarResumo);
        document.getElementById('filtro-ano').addEventListener('change', atualizarResumo);
        document.getElementById('filtro-lote').addEventListener('change', atualizarResumo);

        // Anima√ß√µes de fade-in
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observar elementos com classe fade-in
        document.querySelectorAll('.fade-in').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(el);
        });

        // Atualizar data/hora do √∫ltimo acesso
        function updateLastAccess() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('ultimo-acesso').textContent = `${dateStr} - ${timeStr}`;
        }

        updateLastAccess();

        // Efeitos hover nos cards de lote
        document.querySelectorAll('.lote-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(-6px)';
            });
        });

        // Controle da notifica√ß√£o de login bem-sucedido
        function closeNotification() {
            const notification = document.getElementById('loginSuccessNotification');
            if (notification) {
                notification.classList.add('closing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // Auto-fechar notifica√ß√£o ap√≥s 5 segundos
        window.addEventListener('load', function() {
            const notification = document.getElementById('loginSuccessNotification');
            if (notification) {
                // Efeito visual sutil ao aparecer
                notification.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    notification.style.transition = 'transform 0.2s ease';
                    notification.style.transform = 'scale(1)';
                }, 100);
                
                // Auto-fechar ap√≥s 5 segundos
                setTimeout(() => {
                    closeNotification();
                }, 5000);
            }
        });

        // Placeholder para funcionalidades futuras
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href="#relatorios"]')) {
                e.preventDefault();
                alert('M√≥dulo de Relat√≥rios ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
            
            if (e.target.closest('a[href="#configuracoes"]')) {
                e.preventDefault();
                alert('M√≥dulo de Configura√ß√µes ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
        });
    </script>
</body>
</html>
