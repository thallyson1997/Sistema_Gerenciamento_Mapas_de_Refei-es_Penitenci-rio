<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Lote - SGMRP</title>
    <meta name="description" content="Detalhes do lote contratual com mapas de refei√ß√µes e indicadores">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('dashboard') }}" class="logo">SGMRP</a>
                <nav>
                    <ul>
                        <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('lotes') }}">Lotes</a></li>
                        <li><a href="#relatorios">Relat√≥rios</a></li>
                        <li><a href="#configuracoes">Configura√ß√µes</a></li>
                        <li><a href="#" id="logoutLink" style="color: #fed7d7;">Sair</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Breadcrumb -->
            <nav aria-label="Navega√ß√£o" style="margin-bottom: 2rem;">
                <ol style="display: flex; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-500);">
                    <li><a href="{{ url_for('dashboard') }}" style="color: var(--primary-color); text-decoration: none;">Dashboard</a></li>
                    <li aria-hidden="true">/</li>
                    <li><a href="{{ url_for('lotes') }}" style="color: var(--primary-color); text-decoration: none;">Lotes</a></li>
                    <li aria-hidden="true">/</li>
                    <li aria-current="page" id="breadcrumb-lote">{{ lote.nome }}</li>
                </ol>
            </nav>

            <!-- Header do Lote -->
            <section class="card" style="margin-bottom: 2rem;">
                <div class="card-body" style="padding: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 2rem; align-items: start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <h1 style="margin: 0; color: var(--primary-color);" id="titulo-lote">{{ lote.nome }}</h1>
                                {% if lote.ativo %}
                                <div class="badge" style="background-color: var(--success-color); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.875rem;">
                                    ATIVO
                                </div>
                                {% else %}
                                <div class="badge" style="background-color: var(--gray-400); color: white; padding: 0.5rem 1rem; border-radius: 1rem; font-size: 0.875rem;">
                                    INATIVO
                                </div>
                                {% endif %}
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                                <div>
                                    <strong>Empresa Respons√°vel:</strong><br>
                                    <span id="empresa-nome">{{ lote.empresa }}</span>
                                </div>
                                <div>
                                    <strong>Contrato:</strong><br>
                                    <span>{{ lote.contrato }} - {{ lote.data_inicio_contrato }}</span>
                                </div>
                                <div>
                                    <strong>Unidades Ativas:</strong><br>
                                    <span id="unidades-count">
                                        {{ unidades_lote | length }} unidades
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìä</div>
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary-color);" id="conformidade-geral">
                                {% if lote.id == 1 %}96.8%
                                {% elif lote.id == 2 %}91.5%
                                {% elif lote.id == 3 %}98.2%
                                {% elif lote.id == 4 %}89.7%
                                {% elif lote.id == 5 %}94.3%
                                {% elif lote.id == 6 %}87.9%
                                {% elif lote.id == 7 %}92.1%
                                {% elif lote.id == 8 %}95.6%
                                {% elif lote.id == 9 %}93.4%
                                {% else %}95.0%{% endif %}
                            </div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">Conformidade Geral</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filtros e Controles -->
            <section class="filters" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: end; gap: 1rem; flex-wrap: wrap;">
                    <div style="display: flex; gap: 1rem; align-items: end;">
                        <div class="periodo-filter-container">
                            <label class="form-label">Per√≠odo</label>
                            <div class="periodo-display" id="periodo-display">
                                <span class="periodo-text" id="periodo-text">Setembro/2025</span>
                                <span class="periodo-icon">üìÖ</span>
                            </div>
                            
                            <!-- Overlay para fechar calend√°rio -->
                            <div class="calendario-overlay" id="calendario-overlay"></div>
                            
                            <!-- Popup do calend√°rio -->
                            <div class="calendario-popup" id="calendario-popup">
                                <div class="calendario-header">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üìÖ Selecionar Per√≠odo</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as datas de in√≠cio e fim para filtrar os dados</p>
                                </div>
                                
                                <div class="calendario-body">
                                    <div class="periodo-inputs">
                                        <div class="date-input-group">
                                            <label class="date-input-label">ÔøΩ In√≠cio</label>
                                            <input type="date" class="date-input" id="data-inicio" value="2025-09-01">
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">ÔøΩ Fim</label>
                                            <input type="date" class="date-input" id="data-fim" value="2025-09-30">
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">üìÖ M√™s</label>
                                            <select class="date-input" id="mes-periodo">
                                                <option value="1">Janeiro</option>
                                                <option value="2">Fevereiro</option>
                                                <option value="3">Mar√ßo</option>
                                                <option value="4">Abril</option>
                                                <option value="5">Maio</option>
                                                <option value="6">Junho</option>
                                                <option value="7">Julho</option>
                                                <option value="8">Agosto</option>
                                                <option value="9">Setembro</option>
                                                <option value="10">Outubro</option>
                                                <option value="11">Novembro</option>
                                                <option value="12">Dezembro</option>
                                            </select>
                                        </div>
                                        <div class="date-input-group">
                                            <label class="date-input-label">üìÖ Ano</label>
                                            <input type="number" class="date-input" id="ano-periodo" min="2020" max="2030">
                                        </div>
                                    </div>
                                    
                                    <div class="calendario-actions">
                                        <div class="periodo-info">
                                            <span id="dias-periodo">30 dias selecionados</span>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn-calendario" id="btn-cancelar-periodo">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-periodo">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="unidades-filter-container">
                            <label class="form-label">Unidades</label>
                            <div class="unidades-display" id="unidades-display">
                                <span class="unidades-text" id="unidades-text">Todas as unidades</span>
                                <span class="unidades-icon">üè¢</span>
                            </div>
                            
                            <!-- Overlay para fechar popup de unidades -->
                            <div class="unidades-overlay" id="unidades-overlay"></div>
                            
                            <!-- Popup de sele√ß√£o de unidades -->
                            <div class="unidades-popup" id="unidades-popup">
                                <div class="unidades-header">
                                    <h4 style="margin: 0; color: var(--primary-color); font-size: 1rem;">üè¢ Selecionar Unidades</h4>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: var(--gray-600);">Escolha as unidades para filtrar os dados</p>
                                </div>
                                
                                <div class="unidades-body">
                                    <div class="unidades-controls">
                                        <button class="control-btn" id="btn-selecionar-todas">‚úÖ Todas</button>
                                        <button class="control-btn" id="btn-limpar-todas">‚ùå Limpar</button>
                                    </div>
                                    
                                    <div class="unidades-list" id="unidades-list">
                                        {% for unidade in unidades_lote %}
                                        <div class="unidade-item" data-value="{{ unidade }}">
                                            <input type="checkbox" class="unidade-checkbox" id="checkbox-unidade{{ loop.index }}" value="{{ unidade }}">
                                            <label class="unidade-label" for="checkbox-unidade{{ loop.index }}">{{ unidade }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <div class="unidades-actions">
                                        <div class="unidades-info">
                                            <span id="unidades-selecionadas-count">
                                                {{ unidades_lote | length }} unidades selecionadas
                                            </span>
                                        </div>
                                        <div class="action-buttons">
                                            <button class="btn-calendario" id="btn-cancelar-unidades">‚ùå Cancelar</button>
                                            <button class="btn-calendario primary" id="btn-aplicar-unidades">‚úÖ Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-secondary" id="btn-importar">
                            üì§ Importar Dados
                        </button>
                        <button class="btn btn-secondary" id="btn-entrada-manual">
                            ‚úèÔ∏è Entrada Manual
                        </button>
                        <button class="btn btn-primary" id="btn-atualizar">
                            üîÑ Atualizar
                        </button>
                    </div>
                </div>
            </section>

            <!-- Resumo e Estat√≠sticas -->
            <section class="card" style="margin-bottom: 2rem;">
                <div class="card-header">
                    <h3>Resumo do Per√≠odo</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 2rem; align-items: center;">
                        <!-- Total Geral - Esquerda -->
                        <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                            <div style="font-size: 2rem; color: var(--primary-color); font-weight: 600;" id="total-refeicoes">28,450</div>
                            <div style="color: var(--gray-600); font-size: 0.875rem;">Total de Refei√ß√µes</div>
                        </div>

                        <!-- Indicadores por Tipo de Refei√ß√£o - Centro -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                            <!-- Linha Superior -->
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-cafe-interno">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Interno</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-cafe-funcionario">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Caf√© Funcion√°rio</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-almoco-interno">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Interno</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-almoco-funcionario">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Almo√ßo Funcion√°rio</div>
                            </div>
                            
                            <!-- Linha Inferior -->
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-lanche-interno">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Interno</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-lanche-funcionario">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Lanche Funcion√°rio</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-jantar-interno">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Interno</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background-color: var(--light-blue); border-radius: var(--border-radius);">
                                <div style="font-size: 1.5rem; color: var(--primary-color); font-weight: 600;" id="total-jantar-funcionario">0</div>
                                <div style="color: var(--gray-600); font-size: 0.75rem;">Jantar Funcion√°rio</div>
                            </div>
                        </div>

                        <!-- Indicadores de Conformidade - Direita -->
                        <div style="display: grid; grid-template-rows: 1fr 1fr; gap: 1rem;">
                            <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                <div style="font-size: 1.8rem; color: var(--warning-color); font-weight: 600;" id="diferencas-pequenas">23</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Diferen√ßas Pequenas</div>
                            </div>
                            <div style="text-align: center; padding: 1.5rem; background-color: var(--gray-50); border-radius: var(--border-radius);">
                                <div style="font-size: 1.8rem; color: var(--danger-color); font-weight: 600;" id="discrepancias-criticas">8</div>
                                <div style="color: var(--gray-600); font-size: 0.875rem;">Discrep√¢ncias Cr√≠ticas</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Se√ß√µes Colaps√°veis -->
            <div style="display: grid; gap: 2rem;">
                <!-- Se√ß√£o de Importa√ß√£o de Dados -->
                <section class="card" id="secao-importacao" style="display: none;">
                    <div class="card-header">
                        <h3>Importa√ß√£o de Dados via PDF</h3>
                    </div>
                    <div class="card-body">
                        <!-- Seletor de M√™s e Ano -->
                        <div class="mes-ano-selector">
                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                <label class="form-label" style="margin: 0; font-weight: 600; color: var(--primary-color);">üìÖ Per√≠odo de Refer√™ncia:</label>
                                <div class="mes-ano-display" id="mes-ano-display-import">
                                    <span class="mes-ano-text" id="mes-ano-text-import">Setembro/2025</span>
                                    <span class="mes-ano-icon">üìÖ</span>
                                </div>
                            </div>
                            <div class="mes-ano-inputs">
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">M√™s</label>
                                    <select id="mes-import" class="mes-ano-input">
                                        <option value="1">Jan</option>
                                        <option value="2">Fev</option>
                                        <option value="3">Mar</option>
                                        <option value="4">Abr</option>
                                        <option value="5">Mai</option>
                                        <option value="6">Jun</option>
                                        <option value="7">Jul</option>
                                        <option value="8">Ago</option>
                                        <option value="9" selected>Set</option>
                                        <option value="10">Out</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dez</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.75rem; color: var(--gray-600); margin-bottom: 0.25rem;">Ano</label>
                                    <input type="number" id="ano-import" class="mes-ano-input" value="2025" min="2020" max="2030">
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label for="select-presidio-import" class="form-label">Unidade</label>
                                    <select id="select-unidade-import" class="form-select" required>
                                        <option value="">Selecione a unidade</option>
                                        {% for unidade in unidades_lote %}
                                        <option value="unidade{{ loop.index }}">{{ unidade }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="texto-pdf" class="form-label">Texto extra√≠do do PDF</label>
                                    <textarea 
                                        id="texto-pdf" 
                                        class="form-textarea" 
                                        rows="8" 
                                        placeholder="Cole aqui o texto extra√≠do do PDF com os dados de refei√ß√µes..."
                                    ></textarea>
                                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                                        Formato esperado: Data, tipo de refei√ß√£o e quantidade por linha
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group">
                                    <label for="dados-siisp" class="form-label">Dados do SIISP (opcional)</label>
                                    <textarea 
                                        id="dados-siisp" 
                                        class="form-textarea" 
                                        rows="4" 
                                        placeholder="Cole os dados de n√∫mero de detentos do SIISP para compara√ß√£o..."
                                    ></textarea>
                                </div>
                                
                                <div style="padding: 1.5rem; background-color: var(--light-blue); border-radius: var(--border-radius); margin-bottom: 1rem;">
                                    <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Exemplo de formato:</h4>
                                    <pre style="font-size: 0.75rem; color: var(--gray-700); margin: 0; white-space: pre-wrap;">01/10/2025 - Caf√© Interno: 120, Funcion√°rio: 15
01/10/2025 - Almo√ßo Interno: 118, Funcion√°rio: 14
01/10/2025 - Jantar Interno: 119, Funcion√°rio: 15</pre>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end; margin-top: 1rem;">
                            <button class="btn btn-secondary" id="btn-cancelar-import">Cancelar</button>
                            <button class="btn btn-primary" id="btn-processar-import">Processar Dados</button>
                        </div>
                    </div>
                </section>

                <!-- Se√ß√£o de Entrada Manual -->
                <section class="card" id="secao-manual" style="display: none;">
                    <div class="card-header">
                        <h3>Entrada Manual de Dados</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="select-presidio-manual" class="form-label">Unidade</label>
                            <select id="select-unidade-manual" class="form-select" required>
                                <option value="">Selecione a unidade</option>
                                {% for unidade in unidades_lote %}
                                <option value="unidade{{ loop.index }}">{{ unidade }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data</label>
                            <input type="date" id="data-manual" class="form-input" value="2025-10-19">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label for="cafe-interno" class="form-label">Caf√© - Internos</label>
                                <input type="number" id="cafe-interno" class="form-input" min="0">
                            </div>
                            <div class="form-group">
                                <label for="cafe-funcionario" class="form-label">Caf√© - Funcion√°rios</label>
                                <input type="number" id="cafe-funcionario" class="form-input" min="0">
                            </div>
                            <div class="form-group">
                                <label for="almoco-interno" class="form-label">Almo√ßo - Internos</label>
                                <input type="number" id="almoco-interno" class="form-input" min="0">
                            </div>
                            <div class="form-group">
                                <label for="almoco-funcionario" class="form-label">Almo√ßo - Funcion√°rios</label>
                                <input type="number" id="almoco-funcionario" class="form-input" min="0">
                            </div>
                            <div class="form-group">
                                <label for="jantar-interno" class="form-label">Jantar - Internos</label>
                                <input type="number" id="jantar-interno" class="form-input" min="0">
                            </div>
                            <div class="form-group">
                                <label for="jantar-funcionario" class="form-label">Jantar - Funcion√°rios</label>
                                <input type="number" id="jantar-funcionario" class="form-input" min="0">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; justify-content: end;">
                            <button class="btn btn-secondary" id="btn-cancelar-manual">Cancelar</button>
                            <button class="btn btn-primary" id="btn-salvar-manual">Salvar Dados</button>
                        </div>
                    </div>
                </section>

                <!-- Sistema de Abas para Tabelas -->
                <section class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 id="titulo-tabela">Mapas de Refei√ß√µes</h3>
                            <div id="indicador-filtros" style="font-size: 0.875rem; color: var(--primary-color); margin-top: 0.25rem; display: none;">
                                <span>üìä Dados filtrados</span>
                                <button id="btn-limpar-filtros" style="margin-left: 0.5rem; background: none; border: none; color: var(--danger-color); text-decoration: underline; cursor: pointer; font-size: 0.875rem;">Limpar filtros</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-secondary" id="btn-legenda">
                                üé® Legenda
                            </button>
                            <button class="btn btn-sm btn-secondary" id="btn-exportar-tabela">
                                üìã Exportar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Abas de Navega√ß√£o -->
                    <div style="border-bottom: 2px solid var(--gray-200); background-color: var(--gray-50);">
                        <div style="display: flex; padding: 0 1rem;">
                            <button class="tab-button active" data-tab="dados-refeicoes" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                                üìä Dados de Refei√ß√µes
                            </button>
                            <button class="tab-button" data-tab="comparacao-siisp" style="padding: 1rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 3px solid transparent; transition: all 0.3s ease;">
                                üéØ Compara√ß√£o SIISP
                            </button>
                        </div>
                    </div>

                    <!-- Conte√∫do das Abas -->
                    <div class="card-body" style="padding: 0;">
                        
                        <!-- Aba 1: Dados de Refei√ß√µes -->
                        <div id="tab-dados-refeicoes" class="tab-content" style="display: block;">
                            <div style="padding: 1rem; background-color: var(--light-blue); border-bottom: 1px solid var(--gray-200);">
                                <p style="margin: 0; font-size: 0.875rem; color: var(--primary-color);">
                                    <strong>üìã Tabela de Entrada:</strong> Visualize apenas os dados de refei√ß√µes inseridos, 
                                    sem compara√ß√£o. Esta √© a tabela base com os n√∫meros originais reportados.
                                </p>
                            </div>
                            <div class="table-container">
                                <table class="table" id="tabela-dados-refeicoes">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Data</th>
                                            <th rowspan="2">Unidade</th>
                                            <th colspan="2">Caf√©</th>
                                            <th colspan="2">Almo√ßo</th>
                                            <th colspan="2">Lanche</th>
                                            <th colspan="2">Jantar</th>
                                            <th rowspan="2">Total Dia</th>
                                        </tr>
                                        <tr>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-dados-refeicoes">
                                        <!-- Dados ser√£o inseridos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Aba 2: Compara√ß√£o SIISP -->
                        <div id="tab-comparacao-siisp" class="tab-content" style="display: none;">
                            <div style="padding: 1rem; background-color: #fff3cd; border-bottom: 1px solid var(--gray-200);">
                                <p style="margin: 0; font-size: 0.875rem; color: #856404;">
                                    <strong>üéØ Tabela de Compara√ß√£o:</strong> Dados comparados com o SIISP, com indicadores 
                                    coloridos. Verde (OK), Azul (diferen√ßa 1-5), Vermelho (diferen√ßa >5).
                                </p>
                            </div>
                            <div class="table-container">
                                <table class="table" id="tabela-comparacao-siisp">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Data</th>
                                            <th rowspan="2">Unidade</th>
                                            <th rowspan="2">SIISP</th>
                                            <th colspan="2">Caf√©</th>
                                            <th colspan="2">Almo√ßo</th>
                                            <th colspan="2">Lanche</th>
                                            <th colspan="2">Jantar</th>
                                        </tr>
                                        <tr>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                            <th>Interno</th>
                                            <th>Func.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-comparacao-siisp">
                                        <!-- Dados ser√£o inseridos via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Modal da Legenda -->
    <div id="modal-legenda" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: var(--border-radius-xl); padding: 2rem; max-width: 500px; width: 90%;">
            <h3 style="margin-bottom: 1.5rem;">Legenda dos Indicadores</h3>
            
            <div style="display: grid; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--success-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;">OK</div>
                    <div>
                        <strong>Verde:</strong> Diferen√ßa ‚â§ 0 entre internos e SIISP (Conforme)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--warning-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+2</div>
                    <div>
                        <strong>Azul:</strong> Diferen√ßa de 1-5 refei√ß√µes para internos (Aten√ß√£o)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--danger-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+8</div>
                    <div>
                        <strong>Vermelho (Cr√≠tico):</strong> Diferen√ßa > 5 refei√ß√µes para internos
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--success-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: bold;">OK</div>
                    <div>
                        <strong>Verde (Funcion√°rios):</strong> Valores negativos SIISP funcion√°rios (normais)
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 30px; height: 30px; background-color: var(--danger-color); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem;">+5</div>
                    <div>
                        <strong>Vermelho (Funcion√°rios):</strong> Valores positivos SIISP funcion√°rios (an√¥malo)
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-primary" id="btn-fechar-legenda">Fechar</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container text-center">
            <p style="margin: 0; color: var(--gray-400); font-size: 0.875rem;">
                ¬© 2025 SGMRP - Sistema de Gerenciamento de Mapas de Refei√ß√µes Penitenci√°rio
            </p>
        </div>
    </footer>

    <script>
        // Dados reais dos mapas do lote - carregados do Flask
        const mapasLote = {{ mapas_lote | tojson }};
        
        // Vari√°veis globais para controle dos filtros
        let filtrosAtivos = {
            dataInicio: null,
            dataFim: null,
            unidadesSelecionadas: []
        };
        
        // Converter dados dos mapas para formato da tabela
        const dadosRefeicoes = [];
        const dadosOriginais = []; // Manter c√≥pia dos dados originais
        
        mapasLote.forEach(mapa => {
            // Para cada dia do m√™s
            for (let i = 0; i < mapa.data.length; i++) {
                const registro = {
                    data: mapa.data[i],
                    unidade: mapa.nome_unidade,
                    cafeInt: mapa.cafe_interno[i],
                    cafeFunc: mapa.cafe_funcionario[i],
                    almocoInt: mapa.almoco_interno[i],
                    almocoFunc: mapa.almoco_funcionario[i],
                    lancheInt: mapa.lanche_interno[i],
                    lancheFunc: mapa.lanche_funcionario[i],
                    jantarInt: mapa.jantar_interno[i],
                    jantarFunc: mapa.jantar_funcionario[i],
                    // Dados SIISP - usar n_siisp se dispon√≠vel, sen√£o 0
                    siispInternos: (mapa.n_siisp && mapa.n_siisp.length > i) ? mapa.n_siisp[i] : 0,
                    temSiisp: mapa.n_siisp && mapa.n_siisp.length > 0,
                    // Dados SIISP dos funcion√°rios
                    cafeFuncSiisp: (mapa.cafe_funcionario_siisp && mapa.cafe_funcionario_siisp.length > i) ? mapa.cafe_funcionario_siisp[i] : null,
                    almocoFuncSiisp: (mapa.almoco_funcionario_siisp && mapa.almoco_funcionario_siisp.length > i) ? mapa.almoco_funcionario_siisp[i] : null,
                    lancheFuncSiisp: (mapa.lanche_funcionario_siisp && mapa.lanche_funcionario_siisp.length > i) ? mapa.lanche_funcionario_siisp[i] : null,
                    jantarFuncSiisp: (mapa.jantar_funcionario_siisp && mapa.jantar_funcionario_siisp.length > i) ? mapa.jantar_funcionario_siisp[i] : null
                };
                dadosOriginais.push(registro);
                dadosRefeicoes.push({...registro}); // C√≥pia para manipula√ß√£o
            }
        });
        
        // Fun√ß√£o para aplicar filtros aos dados
        function aplicarFiltros() {
            // Limpar dados filtrados
            dadosRefeicoes.length = 0;
            
            console.log('=== APLICANDO FILTROS ===');
            console.log('Filtros ativos:', filtrosAtivos);
            console.log('Dados originais total:', dadosOriginais.length);
            
            // Se n√£o h√° filtros ativos, mostrar todos os dados
            if (!filtrosAtivos.dataInicio && !filtrosAtivos.dataFim && filtrosAtivos.unidadesSelecionadas.length === 0) {
                console.log('Nenhum filtro ativo - mostrando todos os dados');
                dadosOriginais.forEach(registro => {
                    dadosRefeicoes.push({...registro});
                });
            } else {
                console.log('Aplicando filtros espec√≠ficos...');
                // Aplicar filtros aos dados originais
                dadosOriginais.forEach(registro => {
                    let incluir = true;
                    
                    // Filtro por per√≠odo
                    if (filtrosAtivos.dataInicio && filtrosAtivos.dataFim) {
                        // Converter data brasileira (DD/MM/YYYY) para formato Date
                        const partesData = registro.data.split('/');
                        const dataRegistro = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                        
                        // Converter strings ISO para Date de forma consistente
                        const [anoInicio, mesInicio, diaInicio] = filtrosAtivos.dataInicio.split('-');
                        const [anoFim, mesFim, diaFim] = filtrosAtivos.dataFim.split('-');
                        const inicio = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                        const fim = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                        

                        
                        if (dataRegistro < inicio || dataRegistro > fim) {
                            incluir = false;
                        }
                    }
                    
                    // Filtro por unidades - aplicar apenas se h√° filtro ativo
                    if (filtrosAtivos.unidadesSelecionadas.length > 0) {
                        const unidadeIncluida = filtrosAtivos.unidadesSelecionadas.some(unidadeSelecionada => {
                            // Comparar nomes completos das unidades (exact match ou contains)
                            const nomeRegistro = registro.unidade.toLowerCase().trim();
                            const nomeSelecionado = unidadeSelecionada.toLowerCase().trim();
                            
                            // console.log('Comparando:', nomeRegistro, 'vs', nomeSelecionado);
                            
                            // Exact match ou contains
                            return nomeRegistro === nomeSelecionado || 
                                   nomeRegistro.includes(nomeSelecionado) ||
                                   nomeSelecionado.includes(nomeRegistro);
                        });
                        
                        if (!unidadeIncluida) {
                            incluir = false;
                        }
                    }
                    
                    if (incluir) {
                        dadosRefeicoes.push({...registro});
                    }
                });
            }
            
            console.log('Dados ap√≥s filtros:', dadosRefeicoes.length);
            console.log('=== FIM FILTROS ===\n');
            
            // Atualizar tabelas
            carregarTabelaRefeicoes();
            atualizarResumoEstatisticas();
            atualizarIndicadorFiltros();
        }
        
        // Fun√ß√£o para atualizar indicador de filtros ativos
        function atualizarIndicadorFiltros() {
            const indicador = document.getElementById('indicador-filtros');
            const totalOriginal = dadosOriginais.length;
            const totalFiltrado = dadosRefeicoes.length;
            
            if (totalFiltrado < totalOriginal) {
                indicador.style.display = 'block';
                indicador.querySelector('span').textContent = 
                    `üìä Exibindo ${totalFiltrado} de ${totalOriginal} registros`;
            } else {
                indicador.style.display = 'none';
            }
        }
        
        // Fun√ß√£o para limpar todos os filtros
        function limparTodosFiltros() {
            // Reset filtros ativos - limpar completamente para mostrar todos os dados
            filtrosAtivos.dataInicio = null;
            filtrosAtivos.dataFim = null;
            filtrosAtivos.unidadesSelecionadas = [];
            
            // Reset inputs de data
            document.getElementById('data-inicio').value = '';
            document.getElementById('data-fim').value = '';
            document.getElementById('periodo-text').textContent = 'Selecionar per√≠odo';
            
            // Reset checkboxes de unidades - selecionar todas
            document.querySelectorAll('.unidade-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            atualizarDisplayUnidades();
            
            // Aplicar filtros (que agora mostrar√° todos os dados)
            aplicarFiltros();
        }

        // Verificar autentica√ß√£o
        window.addEventListener('load', function() {
            const usuarioSalvo = localStorage.getItem('sgmrp_usuario');
            if (!usuarioSalvo) {
                alert('Sess√£o expirada. Redirecionando para login.');
                window.location.href = 'login.html';
                return;
            }

            // Verificar par√¢metros da URL para a√ß√µes espec√≠ficas
            const urlParams = new URLSearchParams(window.location.search);
            const acao = urlParams.get('acao');

            // Interface j√° inicializada pelo Flask com dados din√¢micos

            // Mostrar se√ß√£o espec√≠fica se houver a√ß√£o
            if (acao === 'importar') {
                mostrarSecaoImportacao();
            } else if (acao === 'manual') {
                mostrarSecaoManual();
            }

            // Definir m√™s anterior como padr√£o no filtro
            setDefaultPreviousMonth();
            
            // Inicializar filtro de per√≠odo
            initPeriodoFilter();
            
            // Inicializar filtro de unidades
            initUnidadesFilter();
            
            // Inicializar seletor de m√™s/ano da importa√ß√£o
            initMesAnoImport();
            
            // Aplicar filtros iniciais e carregar dados da tabela
            aplicarFiltros();
            
            // Inicializar sistema de abas
            initTabs();
        });

        // Fun√ß√£o removida - interface agora √© inicializada pelo Flask com dados din√¢micos

        // Fun√ß√£o para definir setembro/2025 como padr√£o (dados dispon√≠veis)
        function setDefaultPreviousMonth() {
            // Definir setembro de 2025 (m√™s com dados dispon√≠veis)
            const dataInicio = new Date(2025, 8, 1); // Setembro = m√™s 8 (0-indexed)
            const dataFim = new Date(2025, 8, 30); // 30 de setembro
            
            // Definir valores nos inputs de data
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            
            if (dataInicioInput && dataFimInput) {
                const dataInicioStr = dataInicio.toISOString().split('T')[0];
                const dataFimStr = dataFim.toISOString().split('T')[0];
                
                dataInicioInput.value = dataInicioStr;
                dataFimInput.value = dataFimStr;
                
                // Definir filtros ativos
                filtrosAtivos.dataInicio = dataInicioStr;
                filtrosAtivos.dataFim = dataFimStr;
                
                atualizarDisplayPeriodo();
            }
        }

        function carregarTabelaRefeicoes() {
            carregarTabelaDados();
            carregarTabelaComparacao();
        }
        
        // Fun√ß√£o para atualizar resumo de estat√≠sticas
        function atualizarResumoEstatisticas() {
            let totalRefeicoes = 0;
            let totalCafeInterno = 0;
            let totalCafeFuncionario = 0;
            let totalAlmocoInterno = 0;
            let totalAlmocoFuncionario = 0;
            let totalLancheInterno = 0;
            let totalLancheFuncionario = 0;
            let totalJantarInterno = 0;
            let totalJantarFuncionario = 0;
            let diferencasPequenas = 0;
            let discrepanciasCriticas = 0;
            
            dadosRefeicoes.forEach(row => {
                // Somar totais por tipo de refei√ß√£o
                totalCafeInterno += row.cafeInt;
                totalCafeFuncionario += row.cafeFunc;
                totalAlmocoInterno += row.almocoInt;
                totalAlmocoFuncionario += row.almocoFunc;
                totalLancheInterno += row.lancheInt;
                totalLancheFuncionario += row.lancheFunc;
                totalJantarInterno += row.jantarInt;
                totalJantarFuncionario += row.jantarFunc;
                
                // Calcular total geral
                const totalDia = row.cafeInt + row.cafeFunc + row.almocoInt + row.almocoFunc + 
                               row.lancheInt + row.lancheFunc + row.jantarInt + row.jantarFunc;
                totalRefeicoes += totalDia;
                
                // SIISP simulado para c√°lculo de conformidade (mantido temporariamente)
                let siisp = 120;
                if (row.unidade.includes('Norte')) siisp = 98;
                else if (row.unidade.includes('Industrial')) siisp = 105;
                
                // Verificar cada refei√ß√£o de internos para diferen√ßas
                const refeicoes = [row.cafeInt, row.almocoInt, row.lancheInt, row.jantarInt];
                refeicoes.forEach(refeicao => {
                    const diferenca = refeicao - siisp;
                    if (diferenca > 0 && diferenca <= 5) {
                        diferencasPequenas++;
                    } else if (diferenca > 5) {
                        discrepanciasCriticas++;
                    }
                });
            });
            
            // Atualizar elementos na p√°gina com os novos IDs
            const totalRefeicoes_elemento = document.getElementById('total-refeicoes');
            const totalCafeInterno_elemento = document.getElementById('total-cafe-interno');
            const totalCafeFuncionario_elemento = document.getElementById('total-cafe-funcionario');
            const totalAlmocoInterno_elemento = document.getElementById('total-almoco-interno');
            const totalAlmocoFuncionario_elemento = document.getElementById('total-almoco-funcionario');
            const totalLancheInterno_elemento = document.getElementById('total-lanche-interno');
            const totalLancheFuncionario_elemento = document.getElementById('total-lanche-funcionario');
            const totalJantarInterno_elemento = document.getElementById('total-jantar-interno');
            const totalJantarFuncionario_elemento = document.getElementById('total-jantar-funcionario');
            const diferencasPequenas_elemento = document.getElementById('diferencas-pequenas');
            const discrepanciasCriticas_elemento = document.getElementById('discrepancias-criticas');
            
            // Atualizar valores
            if (totalRefeicoes_elemento) totalRefeicoes_elemento.textContent = totalRefeicoes.toLocaleString('pt-BR');
            if (totalCafeInterno_elemento) totalCafeInterno_elemento.textContent = totalCafeInterno.toLocaleString('pt-BR');
            if (totalCafeFuncionario_elemento) totalCafeFuncionario_elemento.textContent = totalCafeFuncionario.toLocaleString('pt-BR');
            if (totalAlmocoInterno_elemento) totalAlmocoInterno_elemento.textContent = totalAlmocoInterno.toLocaleString('pt-BR');
            if (totalAlmocoFuncionario_elemento) totalAlmocoFuncionario_elemento.textContent = totalAlmocoFuncionario.toLocaleString('pt-BR');
            if (totalLancheInterno_elemento) totalLancheInterno_elemento.textContent = totalLancheInterno.toLocaleString('pt-BR');
            if (totalLancheFuncionario_elemento) totalLancheFuncionario_elemento.textContent = totalLancheFuncionario.toLocaleString('pt-BR');
            if (totalJantarInterno_elemento) totalJantarInterno_elemento.textContent = totalJantarInterno.toLocaleString('pt-BR');
            if (totalJantarFuncionario_elemento) totalJantarFuncionario_elemento.textContent = totalJantarFuncionario.toLocaleString('pt-BR');
            if (diferencasPequenas_elemento) diferencasPequenas_elemento.textContent = diferencasPequenas.toString();
            if (discrepanciasCriticas_elemento) discrepanciasCriticas_elemento.textContent = discrepanciasCriticas.toString();
        }

        function carregarTabelaDados() {
            const tbody = document.getElementById('tbody-dados-refeicoes');
            tbody.innerHTML = '';

            dadosRefeicoes.forEach(row => {
                const tr = document.createElement('tr');
                const totalDia = row.cafeInt + row.cafeFunc + row.almocoInt + row.almocoFunc + row.lancheInt + row.lancheFunc + row.jantarInt + row.jantarFunc;
                
                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td>${row.unidade}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.cafeInt}</td>
                    <td style="text-align: center;">${row.cafeFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.almocoInt}</td>
                    <td style="text-align: center;">${row.almocoFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.lancheInt}</td>
                    <td style="text-align: center;">${row.lancheFunc}</td>
                    <td style="text-align: center; background-color: var(--gray-50);">${row.jantarInt}</td>
                    <td style="text-align: center;">${row.jantarFunc}</td>
                    <td style="text-align: center; font-weight: 600; background-color: var(--light-blue);">${totalDia}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function carregarTabelaComparacao() {
            const tbody = document.getElementById('tbody-comparacao-siisp');
            tbody.innerHTML = '';

            dadosRefeicoes.forEach(row => {
                const tr = document.createElement('tr');
                
                // Usar dados reais do SIISP ou 0 se n√£o dispon√≠vel
                const siisp = row.siispInternos || 0;
                const statusSiisp = row.temSiisp ? 'Dispon√≠vel' : 'N√£o dispon√≠vel';
                
                // Calcular diferen√ßas e aplicar cores (somente se SIISP dispon√≠vel)
                const cafeClass = siisp > 0 ? getClassificacao(row.cafeInt, siisp) : { class: 'cell-na', display: 'N/A' };
                const almocoClass = siisp > 0 ? getClassificacao(row.almocoInt, siisp) : { class: 'cell-na', display: 'N/A' };
                const lancheClass = siisp > 0 ? getClassificacao(row.lancheInt, siisp) : { class: 'cell-na', display: 'N/A' };
                const jantarClass = siisp > 0 ? getClassificacao(row.jantarInt, siisp) : { class: 'cell-na', display: 'N/A' };

                // Fun√ß√£o para formatar c√©lulas de funcion√°rios SIISP
                function formatarCelulaFuncSiisp(valorFunc, valorSiisp) {
                    if (valorSiisp === null || valorSiisp === undefined) {
                        return {
                            style: 'text-align: center; background-color: var(--gray-200); color: var(--gray-500);',
                            value: 'N/A'
                        };
                    }
                    
                    // Para funcion√°rios SIISP: valores negativos s√£o normais (verde com "OK"), valores > 0 s√£o problem√°ticos (vermelho com n√∫mero)
                    if (valorSiisp > 0) {
                        return {
                            style: 'text-align: center; background-color: var(--danger-color); color: white; font-weight: 600;',
                            value: `+${valorSiisp}`
                        };
                    } else {
                        return {
                            style: 'text-align: center; background-color: var(--success-color); color: white; font-weight: 600;',
                            value: 'OK'
                        };
                    }
                }

                const cafeFuncStyle = formatarCelulaFuncSiisp(row.cafeFunc, row.cafeFuncSiisp);
                const almocoFuncStyle = formatarCelulaFuncSiisp(row.almocoFunc, row.almocoFuncSiisp);
                const lancheFuncStyle = formatarCelulaFuncSiisp(row.lancheFunc, row.lancheFuncSiisp);
                const jantarFuncStyle = formatarCelulaFuncSiisp(row.jantarFunc, row.jantarFuncSiisp);

                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td>${row.unidade}</td>
                    <td style="text-align: center; font-weight: 600; background-color: ${siisp > 0 ? 'var(--success-light)' : 'var(--gray-100)'}; color: ${siisp > 0 ? 'var(--success-color)' : 'var(--gray-500)'}">${siisp}</td>
                    <td class="${cafeClass.class}" style="text-align: center;">
                        ${cafeClass.display}
                    </td>
                    <td style="${cafeFuncStyle.style}">${cafeFuncStyle.value}</td>
                    <td class="${almocoClass.class}" style="text-align: center;">
                        ${almocoClass.display}
                    </td>
                    <td style="${almocoFuncStyle.style}">${almocoFuncStyle.value}</td>
                    <td class="${lancheClass.class}" style="text-align: center;">
                        ${lancheClass.display}
                    </td>
                    <td style="${lancheFuncStyle.style}">${lancheFuncStyle.value}</td>
                    <td class="${jantarClass.class}" style="text-align: center;">
                        ${jantarClass.display}
                    </td>
                    <td style="${jantarFuncStyle.style}">${jantarFuncStyle.value}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        function getClassificacao(refeicoes, siisp) {
            const diferenca = refeicoes - siisp;
            
            if (diferenca <= 0) {
                return { class: 'cell-ok', display: 'OK' };
            } else if (diferenca <= 5) {
                return { class: 'cell-warning', display: `+${diferenca}` };
            } else {
                return { class: 'cell-danger', display: `+${diferenca}` };
            }
        }



        // Controle das Abas
        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // Remover classe active de todos os bot√µes
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.style.borderBottomColor = 'transparent';
                        btn.style.color = 'var(--gray-600)';
                        btn.style.backgroundColor = 'transparent';
                    });
                    
                    // Adicionar classe active ao bot√£o clicado
                    this.classList.add('active');
                    this.style.borderBottomColor = 'var(--primary-color)';
                    this.style.color = 'var(--primary-color)';
                    this.style.backgroundColor = 'white';
                    this.style.marginBottom = '-2px';
                    
                    // Esconder todos os conte√∫dos
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    
                    // Mostrar o conte√∫do da aba selecionada
                    const targetContent = document.getElementById('tab-' + targetTab);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                    }
                });
            });

            // Ativar a primeira aba por padr√£o
            if (tabButtons.length > 0) {
                tabButtons[0].click();
            }
        }

        // Controles das se√ß√µes
        document.getElementById('btn-importar').addEventListener('click', mostrarSecaoImportacao);
        document.getElementById('btn-entrada-manual').addEventListener('click', mostrarSecaoManual);

        function mostrarSecaoImportacao() {
            document.getElementById('secao-importacao').style.display = 'block';
            document.getElementById('secao-manual').style.display = 'none';
            document.getElementById('secao-importacao').scrollIntoView({ behavior: 'smooth' });
        }

        function mostrarSecaoManual() {
            document.getElementById('secao-importacao').style.display = 'none';
            document.getElementById('secao-manual').style.display = 'block';
            document.getElementById('secao-manual').scrollIntoView({ behavior: 'smooth' });
        }

        // Bot√µes de cancelar
        document.getElementById('btn-cancelar-import').addEventListener('click', function() {
            document.getElementById('secao-importacao').style.display = 'none';
        });

        document.getElementById('btn-cancelar-manual').addEventListener('click', function() {
            document.getElementById('secao-manual').style.display = 'none';
        });

        // Inicializar seletor de m√™s/ano da importa√ß√£o
        function initMesAnoImport() {
            const mesSelect = document.getElementById('mes-import');
            const anoInput = document.getElementById('ano-import');
            const mesAnoDisplay = document.getElementById('mes-ano-display-import');
            const mesAnoText = document.getElementById('mes-ano-text-import');
            
            // Definir m√™s anterior como padr√£o
            const now = new Date();
            let mesAnterior = now.getMonth(); // getMonth() retorna 0-11
            let anoAnterior = now.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesSelect.value = mesAnterior.toString();
            anoInput.value = anoAnterior.toString();
            atualizarDisplayMesAno();
            
            // Eventos para atualizar display quando valores mudarem
            mesSelect.addEventListener('change', atualizarDisplayMesAno);
            anoInput.addEventListener('input', atualizarDisplayMesAno);
            
            // Clique no display para focar no primeiro input
            mesAnoDisplay.addEventListener('click', function() {
                mesSelect.focus();
            });
            
            function atualizarDisplayMesAno() {
                const meses = [
                    'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                
                const mesIndex = parseInt(mesSelect.value) - 1;
                const mesNome = meses[mesIndex] || 'M√™s';
                const ano = anoInput.value || 'Ano';
                
                mesAnoText.textContent = `${mesNome}/${ano}`;
            }
        }
        
        // Processar importa√ß√£o
        document.getElementById('btn-processar-import').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-import').value;
            const textoPdf = document.getElementById('texto-pdf').value.trim();
            const mes = document.getElementById('mes-import').value;
            const ano = document.getElementById('ano-import').value;
            
            if (!unidade || !textoPdf) {
                alert('Por favor, selecione a unidade e forne√ßa o texto do PDF.');
                return;
            }
            
            if (!mes || !ano) {
                alert('Por favor, defina o m√™s e ano de refer√™ncia.');
                return;
            }
            
            const meses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            const mesNome = meses[parseInt(mes) - 1];
            
            alert(`Dados processados com sucesso!\nPer√≠odo: ${mesNome}/${ano}\nNovos registros foram adicionados √† tabela.`);
            document.getElementById('secao-importacao').style.display = 'none';
            
            // Aqui seria implementada a l√≥gica real de processamento
            console.log('Importa√ß√£o processada:', { unidade, mes: mesNome, ano, textoPdf });
            carregarTabelaRefeicoes();
        });

        // Salvar entrada manual
        document.getElementById('btn-salvar-manual').addEventListener('click', function() {
            const unidade = document.getElementById('select-unidade-manual').value;
            const data = document.getElementById('data-manual').value;
            
            if (!unidade || !data) {
                alert('Por favor, selecione a unidade e a data.');
                return;
            }
            
            alert('Dados salvos com sucesso!\nNovo registro foi adicionado √† tabela.');
            document.getElementById('secao-manual').style.display = 'none';
            
            // Limpar formul√°rio
            document.querySelectorAll('#secao-manual input[type="number"]').forEach(input => {
                input.value = '';
            });
            
            carregarTabelaRefeicoes();
        });

        // Modal da legenda
        document.getElementById('btn-legenda').addEventListener('click', function() {
            document.getElementById('modal-legenda').style.display = 'block';
        });

        document.getElementById('btn-fechar-legenda').addEventListener('click', function() {
            document.getElementById('modal-legenda').style.display = 'none';
        });

        // Fechar modal clicando fora
        document.getElementById('modal-legenda').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Atualizar dados
        document.getElementById('btn-atualizar').addEventListener('click', function() {
            // Aplicar filtros atuais
            aplicarFiltros();
            alert('Dados atualizados com sucesso!');
        });

        // Exportar tabela
        document.getElementById('btn-exportar-tabela').addEventListener('click', function() {
            alert('Funcionalidade de exporta√ß√£o ser√° implementada em vers√µes futuras.\n\nFormatos dispon√≠veis: Excel, PDF, CSV');
        });
        
        // Limpar filtros
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'btn-limpar-filtros') {
                if (confirm('Deseja limpar todos os filtros e exibir todos os dados?')) {
                    limparTodosFiltros();
                }
            }
        });

        // Logout
        document.getElementById('logoutLink').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                localStorage.removeItem('sgmrp_usuario');
                localStorage.removeItem('sgmrp_remember');
                window.location.href = 'login.html';
            }
        });

        // Controle do filtro de per√≠odo
        function initPeriodoFilter() {
            const periodoDisplay = document.getElementById('periodo-display');
            const calendarioPopup = document.getElementById('calendario-popup');
            const calendarioOverlay = document.getElementById('calendario-overlay');
            const dataInicio = document.getElementById('data-inicio');
            const dataFim = document.getElementById('data-fim');
            const btnAplicar = document.getElementById('btn-aplicar-periodo');
            const btnCancelar = document.getElementById('btn-cancelar-periodo');
            
            // Abrir calend√°rio
            periodoDisplay.addEventListener('click', function() {
                calendarioPopup.style.display = 'block';
                calendarioOverlay.style.display = 'block';
                periodoDisplay.classList.add('active');
                atualizarInfoDias();
            });
            
            // Fechar calend√°rio
            function fecharCalendario() {
                calendarioPopup.style.display = 'none';
                calendarioOverlay.style.display = 'none';
                periodoDisplay.classList.remove('active');
            }
            
            calendarioOverlay.addEventListener('click', fecharCalendario);
            btnCancelar.addEventListener('click', fecharCalendario);
            
            // Aplicar per√≠odo
            btnAplicar.addEventListener('click', function() {
                // Atualizar filtros ativos
                filtrosAtivos.dataInicio = dataInicio.value;
                filtrosAtivos.dataFim = dataFim.value;
                
                atualizarDisplayPeriodo();
                atualizarTituloPeriodo();
                fecharCalendario();
                
                // Aplicar filtros e atualizar tabela
                console.log('Aplicando filtro de per√≠odo:', dataInicio.value, 'at√©', dataFim.value);
                console.log('Dados originais:', dadosOriginais.length, 'registros');
                aplicarFiltros();
                console.log('Dados filtrados:', dadosRefeicoes.length, 'registros');
            });
            
            // Atualizar info de dias quando as datas mudarem
            dataInicio.addEventListener('change', atualizarInfoDias);
            dataFim.addEventListener('change', atualizarInfoDias);
            
            // Seletor de m√™s/ano
            const mesPeriodo = document.getElementById('mes-periodo');
            const anoPeriodo = document.getElementById('ano-periodo');
            
            // Definir m√™s anterior como padr√£o
            const hoje = new Date();
            let mesAnterior = hoje.getMonth(); // 0-11 (outubro = 9)
            let anoAnterior = hoje.getFullYear();
            
            if (mesAnterior === 0) {
                mesAnterior = 12;
                anoAnterior--;
            }
            
            mesPeriodo.value = mesAnterior.toString();
            anoPeriodo.value = anoAnterior.toString();
            
            // Fun√ß√£o para atualizar as datas quando m√™s/ano mudarem
            function atualizarDatasPorMesAno() {
                const mes = parseInt(mesPeriodo.value);
                const ano = parseInt(anoPeriodo.value);
                
                // Calcular primeiro e √∫ltimo dia do m√™s
                const primeiroDia = new Date(ano, mes - 1, 1);
                const ultimoDia = new Date(ano, mes, 0);
                
                // Definir valores nos inputs
                dataInicio.value = primeiroDia.toISOString().split('T')[0];
                dataFim.value = ultimoDia.toISOString().split('T')[0];
                
                // Atualizar display
                atualizarInfoDias();
            }
            
            // Event listeners para atualiza√ß√£o autom√°tica
            mesPeriodo.addEventListener('change', atualizarDatasPorMesAno);
            anoPeriodo.addEventListener('change', atualizarDatasPorMesAno);
            
            // Aplicar o m√™s anterior inicial
            atualizarDatasPorMesAno();
        }
        
        function atualizarInfoDias() {
            const dataInicioValue = document.getElementById('data-inicio').value;
            const dataFimValue = document.getElementById('data-fim').value;
            const diasInfo = document.getElementById('dias-periodo');
            
            if (dataInicioValue && dataFimValue) {
                // Converter strings ISO para Date de forma consistente
                const [anoInicio, mesInicio, diaInicio] = dataInicioValue.split('-');
                const [anoFim, mesFim, diaFim] = dataFimValue.split('-');
                const dataInicio = new Date(parseInt(anoInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
                const dataFim = new Date(parseInt(anoFim), parseInt(mesFim) - 1, parseInt(diaFim));
                
                if (dataInicio <= dataFim) {
                    const diffTime = Math.abs(dataFim - dataInicio);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Contar quantos registros est√£o no per√≠odo - converter data brasileira
                    const registrosNoPeriodo = dadosOriginais.filter(registro => {
                        const partesData = registro.data.split('/');
                        const dataRegistro = new Date(partesData[2], partesData[1] - 1, partesData[0]);
                        return dataRegistro >= dataInicio && dataRegistro <= dataFim;
                    }).length;
                    
                    diasInfo.textContent = `${diffDays} dias selecionados (${registrosNoPeriodo} registros)`;
                } else {
                    diasInfo.textContent = 'Data de in√≠cio deve ser anterior √† data de fim';
                }
            } else {
                diasInfo.textContent = 'Selecione as datas de in√≠cio e fim';
            }
        }
        
        function atualizarDisplayPeriodo() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            const periodoText = document.getElementById('periodo-text');
            
            if (dataInicio && dataFim) {
                // Usar split para evitar problemas de timezone
                const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                const [anoFim, mesFim, diaFim] = dataFim.split('-');
                
                const inicioFormatado = `${diaInicio}/${mesInicio}/${anoInicio}`;
                const fimFormatado = `${diaFim}/${mesFim}/${anoFim}`;
                
                periodoText.textContent = `${inicioFormatado} - ${fimFormatado}`;
            }
        }
        
        function atualizarTituloPeriodo() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            const titulo = document.querySelector('.card-header h3');
            
            if (dataInicio && dataFim && titulo) {
                // Usar split para evitar problemas de timezone
                const [anoInicio, mesInicio, diaInicio] = dataInicio.split('-');
                const [anoFim, mesFim, diaFim] = dataFim.split('-');
                
                const inicioFormatado = `${diaInicio}/${mesInicio}/${anoInicio}`;
                const fimFormatado = `${diaFim}/${mesFim}/${anoFim}`;
                
                titulo.textContent = `Mapas de Refei√ß√µes - ${inicioFormatado} a ${fimFormatado}`;
            }
        }

        // Controle do filtro de unidades multi-select
        function initUnidadesFilter() {
            const unidadesDisplay = document.getElementById('unidades-display');
            const unidadesPopup = document.getElementById('unidades-popup');
            const unidadesOverlay = document.getElementById('unidades-overlay');
            const btnAplicar = document.getElementById('btn-aplicar-unidades');
            const btnCancelar = document.getElementById('btn-cancelar-unidades');
            const btnSelecionarTodas = document.getElementById('btn-selecionar-todas');
            const btnLimparTodas = document.getElementById('btn-limpar-todas');
            
            let unidadesSelecionadasBackup = [];
            
            // Inicializar com todas as unidades selecionadas
            const checkboxes = document.querySelectorAll('.unidade-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            
            // Definir unidades nos filtros ativos - come√ßar com todas selecionadas (sem filtro)
            filtrosAtivos.unidadesSelecionadas = [];
            atualizarDisplayUnidades();
            
            // Abrir popup de unidades
            unidadesDisplay.addEventListener('click', function() {
                // Fazer backup das sele√ß√µes atuais
                unidadesSelecionadasBackup = getUnidadesSelecionadas();
                
                unidadesPopup.style.display = 'block';
                unidadesOverlay.style.display = 'block';
                unidadesDisplay.classList.add('active');
                atualizarCountUnidades();
            });
            
            // Fechar popup de unidades
            function fecharUnidadesPopup() {
                unidadesPopup.style.display = 'none';
                unidadesOverlay.style.display = 'none';
                unidadesDisplay.classList.remove('active');
            }
            
            unidadesOverlay.addEventListener('click', function() {
                // Restaurar sele√ß√µes anteriores ao cancelar
                restaurarSelecoes(unidadesSelecionadasBackup);
                fecharUnidadesPopup();
            });
            
            btnCancelar.addEventListener('click', function() {
                // Restaurar sele√ß√µes anteriores ao cancelar
                restaurarSelecoes(unidadesSelecionadasBackup);
                fecharUnidadesPopup();
            });
            
            // Aplicar sele√ß√£o de unidades
            btnAplicar.addEventListener('click', function() {
                const unidadesSelecionadas = getUnidadesSelecionadas();
                const totalCheckboxes = document.querySelectorAll('.unidade-checkbox').length;
                
                // Se todas as unidades est√£o selecionadas, limpar filtro (mostrar todas)
                if (unidadesSelecionadas.length === totalCheckboxes) {
                    filtrosAtivos.unidadesSelecionadas = [];
                } else {
                    filtrosAtivos.unidadesSelecionadas = unidadesSelecionadas;
                }
                
                atualizarDisplayUnidades();
                fecharUnidadesPopup();
                
                // Aplicar filtros e atualizar tabela
                console.log('Aplicando filtro de unidades:', filtrosAtivos.unidadesSelecionadas);
                console.log('Dados originais:', dadosOriginais.length, 'registros');
                aplicarFiltros();
                console.log('Dados filtrados:', dadosRefeicoes.length, 'registros');
            });
            
            // Selecionar todas as unidades
            btnSelecionarTodas.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = true;
                });
                atualizarCountUnidades();
            });
            
            // Limpar todas as sele√ß√µes
            btnLimparTodas.addEventListener('click', function() {
                checkboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                atualizarCountUnidades();
            });
            
            // Atualizar contador quando checkboxes mudarem
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', atualizarCountUnidades);
            });
            
            // Permitir clicar no item todo para marcar/desmarcar
            document.querySelectorAll('.unidade-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox' && e.target.tagName !== 'LABEL') {
                        const checkbox = this.querySelector('.unidade-checkbox');
                        checkbox.checked = !checkbox.checked;
                        atualizarCountUnidades();
                    }
                });
            });
        }
        
        function getUnidadesSelecionadas() {
            const checkboxes = document.querySelectorAll('.unidade-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function restaurarSelecoes(unidades) {
            const checkboxes = document.querySelectorAll('.unidade-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = unidades.includes(checkbox.value);
            });
            atualizarCountUnidades();
        }
        
        function atualizarCountUnidades() {
            const selecionadas = getUnidadesSelecionadas();
            const countElement = document.getElementById('unidades-selecionadas-count');
            const total = document.querySelectorAll('.unidade-checkbox').length;
            
            if (selecionadas.length === 0) {
                countElement.textContent = 'Nenhuma unidade selecionada';
            } else if (selecionadas.length === total) {
                countElement.textContent = 'Todas as unidades selecionadas';
            } else if (selecionadas.length === 1) {
                countElement.textContent = '1 unidade selecionada';
            } else {
                countElement.textContent = `${selecionadas.length} unidades selecionadas`;
            }
        }
        
        function atualizarDisplayUnidades() {
            const selecionadas = getUnidadesSelecionadas();
            const unidadesText = document.getElementById('unidades-text');
            const total = document.querySelectorAll('.unidade-checkbox').length;
            
            if (selecionadas.length === 0) {
                unidadesText.textContent = 'Nenhuma unidade';
            } else if (selecionadas.length === total) {
                unidadesText.textContent = 'Todas as unidades';
            } else if (selecionadas.length === 1) {
                // Mostrar o nome da unidade selecionada
                const checkbox = document.querySelector(`input[value="${selecionadas[0]}"]`);
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                unidadesText.textContent = label.textContent;
            } else {
                unidadesText.textContent = `${selecionadas.length} unidades`;
            }
        }

        // Placeholder para links n√£o implementados
        document.addEventListener('click', function(e) {
            if (e.target.closest('a[href="#relatorios"]')) {
                e.preventDefault();
                alert('M√≥dulo de Relat√≥rios ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
            
            if (e.target.closest('a[href="#configuracoes"]')) {
                e.preventDefault();
                alert('M√≥dulo de Configura√ß√µes ser√° implementado na pr√≥xima vers√£o do SGMRP.');
            }
        });
    </script>
</body>
</html>
